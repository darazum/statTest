Ну что, в сухом остатвке мне не удалось достигнуть заказанных 10k rps.

Максимум до скольки я разогнал без ошибок это ~2k rps. Дальше начинаются плохие воротца 502, nginx не может достучаться до swoole который просто умирает.
Потом кстати оживает когда нагрузка уходит, но оживает как-то плохо, такое ощущение, что остаются артефакты падения (после падений показатели хуже, рестарт помогает).

По моим ощущениям у упираюсь в производительность собственного ноута.
На скриншоте видно что все ядра почти в полку (не до конца, видимо чтоб утилизировать проц на 100% из докера нужно предпринять доп. шаги).

Померил сами запросы внутри, там тысячные доли.
request in 0.0001 seconds
redis incr in 0.0001 seconds

Медленные запросы (свыше 0,01 сек вообще отсутствтуют).

В добавок заметил, что на бенчмарке довольно большую долю съедает сам wrk и начинает конкурировать за ресурсы с самим приложением.

Мне видится что архитектурно решение рабочее, но проверять его нужно на отдельной железке на котором будет только оно.

Однако отмечу, что проба пера со swoole не оставила у меня сильно положительных ощущений
- сложно дебажить
- каждый коммит => пересборка
- да и вообще, сервер на PHP это такое себе, такие вещи на Go пишут
- еще появился дурацкий SwooleRequestBridge из-за того что swoole by design не дружит со slim и чтобы преобразовать один запрос в другой нужен этот "мост"


Да, сами бенчи текстом
Вот хороший:
Running 20s test @ http://localhost:8080/visit?country=RU
  2 threads and 2 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.51ms    1.23ms  19.00ms   78.53%
    Req/Sec   717.62    762.79     2.33k    79.00%
  28573 requests in 20.01s, 4.03MB read
Requests/sec:   1427.91
Transfer/sec:    206.37KB


А вот плохой когда swoole поплохело
d.razumovskiy@LIN103769:~/work/statTest$ wrk -t1 -c10 -d20s "http://localhost:8080/visit?country=RU"
Running 20s test @ http://localhost:8080/visit?country=RU
  1 threads and 10 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.86ms    2.68ms  38.12ms   61.99%
    Req/Sec     4.12k     4.34k   20.68k    80.00%
  81986 requests in 20.01s, 15.50MB read
  Non-2xx or 3xx responses: 24802
Requests/sec:   4097.73
Transfer/sec:    793.19KB

Вообще кажется, что на современном ноуте должно выжиматься >>2k коннектов в сек, так что есть куда покопать.

В любом случае за задачку спасибо, было интересно!